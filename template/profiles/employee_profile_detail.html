{% extends "base.html" %}

{% block title %}{{ profile.user.get_full_name|default:profile.user.username }}のプロフィール - MyMoE{% endblock %}

{% block content %}

<div class="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- プロフィールヘッダー -->
    <div class="bg-white overflow-hidden shadow rounded-lg mb-6">
        <div class="px-4 py-5 sm:p-6">
            <div class="flex flex-col sm:flex-row items-center sm:items-start sm:justify-between">
                <div class="flex flex-col sm:flex-row items-center sm:items-start">
                    <!-- アバター -->
                    <div class="flex-shrink-0 mb-4 sm:mb-0 sm:mr-6">
                        {% if profile.photo %}
                            <img src="{{ profile.photo.url }}" alt="プロフィール写真"
                                class="h-24 w-24 rounded-full object-cover shadow-lg border-4 border-white ring-2 ring-primary-500">
                        {% else %}
                            <div class="h-24 w-24 rounded-full bg-gradient-to-r from-primary-400 to-primary-600 flex items-center justify-center shadow-lg border-4 border-white ring-2 ring-primary-500">
                                <span class="text-3xl font-bold text-white">
                                    {{ profile.user.get_full_name|default:profile.user.username|slice:":1"|upper }}
                                </span>
                            </div>
                        {% endif %}
                    </div>
                    <!-- 基本情報 -->
                    <div class="text-center sm:text-left">
                        <div class="flex items-center justify-center sm:justify-start">
                            <h1 class="text-3xl font-bold text-gray-900">
                                {{ profile.user.get_full_name|default:profile.user.username }}
                            </h1>
                            {% if profile.user.is_staff %}
                            <span class="ml-3 inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-purple-100 text-purple-800">
                                <svg class="mr-1 h-3 w-3" fill="currentColor" viewBox="0 0 8 8">
                                    <circle cx="4" cy="4" r="3" />
                                </svg>
                                管理者
                            </span>
                            {% endif %}
                            {% if profile.user.is_hr %}
                            <span class="ml-2 inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                                HR
                            </span>
                            {% endif %}
                        </div>
                        <p class="text-lg text-gray-600">@{{ profile.user.username }}</p>
                        <div class="mt-2 flex items-center justify-center sm:justify-start text-sm text-gray-500">
                            <svg class="flex-shrink-0 mr-1.5 h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 4.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                            </svg>
                            {{ profile.user.email }}
                        </div>
                        {% if profile.user.last_login %}
                        <div class="mt-1 flex items-center justify-center sm:justify-start text-sm text-gray-500">
                            <svg class="flex-shrink-0 mr-1.5 h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                            最終ログイン: {{ profile.user.last_login|date:"Y年m月d日 H:i" }}
                        </div>
                        {% endif %}
                    </div>
                </div>
                <!-- アクションボタン -->
                <div class="mt-5 sm:mt-0 flex-shrink-0 flex flex-col sm:flex-row items-center justify-center sm:justify-end space-y-3 sm:space-y-0 sm:space-x-3 w-full sm:w-auto">
                    {% if request.user == profile.user %}
                    <a href="{% url 'profiles:employee_profile_update' pk=user.pk %}" class="inline-flex items-center px-4 py-2 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-primary-600 hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 transition-colors duration-200 w-full sm:w-auto justify-center">
                        <svg class="mr-2 h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                        </svg>
                        プロフィール編集
                    </a>
                    {% else %}
                    <button type="button" class="inline-flex items-center px-4 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 w-full sm:w-auto justify-center">
                        <svg class="mr-2 h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 4.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                        </svg>
                        メッセージを送る
                    </button>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- 組織情報 -->
    <div id="user-org-info-container" class="mb-6">
        {% if profile.user.department %}
        <div class="bg-gradient-to-r from-blue-50 to-indigo-50 border-l-4 border-blue-400 p-6 rounded-r-lg shadow-sm">
            <div class="flex items-center">
                <div class="flex-shrink-0">
                    <svg class="h-8 w-8 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-4m-5 0H9m0 0H5m6 0v-4a1 1 0 011-1h2a1 1 0 011 1v4M7 7h10M7 11h4" />
                    </svg>
                </div>
                <div class="ml-4">
                    <h3 class="text-lg font-semibold text-blue-900">組織情報</h3>
                    <div class="mt-2 space-y-1">
                        <p class="text-blue-800">
                            <span class="font-medium">部署:</span> 
                            {{ profile.user.department.name }} 
                            {% if profile.user.department.code %}({{ profile.user.department.code }}){% endif %}
                        </p>
                        <p class="text-blue-800">
                            <span class="font-medium">DTE:</span> 
                            {% if profile.user.dte %}
                                {{ profile.user.dte.name }} 
                                {% if profile.user.dte.code %}({{ profile.user.dte.code }}){% endif %}
                            {% else %}
                                未設定
                            {% endif %}
                        </p>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
    </div>

    <!-- HR専用の組織情報更新セクション -->
    {% if request.user.is_hr %}
    <div class="bg-white shadow rounded-lg mb-6">
        <div class="px-4 py-5 sm:p-6">
            <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4">組織情報の更新</h3>
            <div class="max-w-xl">
                <div class="grid grid-cols-1 gap-4 sm:grid-cols-2">
                    <div>
                        <label for="department-select" class="block text-sm font-medium text-gray-700">部署</label>
                        <select id="department-select" name="department" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-primary-500 focus:border-primary-500 sm:text-sm rounded-md">
                            <option value="">部署を選択</option>
                            {% for department in departments %}
                                <option value="{{ department.id }}" {% if profile.user.department.id == department.id %}selected{% endif %}>{{ department.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div>
                        <label for="dte-select" class="block text-sm font-medium text-gray-700">DTE</label>
                        <select id="dte-select" name="dte" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-primary-500 focus:border-primary-500 sm:text-sm rounded-md">
                            <option value="">DTEを選択</option>
                        </select>
                    </div>
                </div>
                <div class="mt-4 flex items-center space-x-3">
                    <button id="update-org-info-btn" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-primary-600 hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500">
                        <svg class="mr-2 h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" />
                        </svg>
                        更新
                    </button>
                    <div id="update-status" class="text-sm"></div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- 詳細情報 -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- 連絡先情報 -->
        <div class="bg-white shadow rounded-lg">
            <div class="px-4 py-5 sm:p-6">
                <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4">連絡先情報</h3>
                <dl class="space-y-4">
                    <div>
                        <dt class="text-sm font-medium text-gray-500">メールアドレス</dt>
                        <dd class="mt-1 text-sm text-gray-900 flex items-center">
                            <svg class="flex-shrink-0 mr-2 h-4 w-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 4.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                            </svg>
                            <a href="mailto:{{ profile.user.email }}" class="text-primary-600 hover:text-primary-500">
                                {{ profile.user.email }}
                            </a>
                        </dd>
                    </div>
                    {% if profile.phone_number %}
                    <div>
                        <dt class="text-sm font-medium text-gray-500">電話番号</dt>
                        <dd class="mt-1 text-sm text-gray-900 flex items-center">
                            <svg class="flex-shrink-0 mr-2 h-4 w-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z" />
                            </svg>
                            {{ profile.phone_number }}
                        </dd>
                    </div>
                    {% endif %}
                </dl>
            </div>
        </div>

        <!-- 個人情報 -->
        <div class="bg-white shadow rounded-lg">
            <div class="px-4 py-5 sm:p-6">
                <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4">個人情報</h3>
                <dl class="space-y-4">
                    {% if profile.date_of_birth %}
                    <div>
                        <dt class="text-sm font-medium text-gray-500">生年月日</dt>
                        <dd class="mt-1 text-sm text-gray-900 flex items-center">
                            <svg class="flex-shrink-0 mr-2 h-4 w-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                            </svg>
                            {{ profile.date_of_birth|date:"Y年m月d日" }}
                        </dd>
                    </div>
                    {% endif %}
                    <div>
                        <dt class="text-sm font-medium text-gray-500">参加日</dt>
                        <dd class="mt-1 text-sm text-gray-900 flex items-center">
                            <svg class="flex-shrink-0 mr-2 h-4 w-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                            {{ profile.user.date_joined|date:"Y年m月d日" }}
                        </dd>
                    </div>
                </dl>
            </div>
        </div>
    </div>

    <!-- 自己紹介 -->
    {% if profile.bio %}
    <div class="mt-6 bg-white shadow rounded-lg">
        <div class="px-4 py-5 sm:p-6">
            <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4">自己紹介</h3>
            <div class="prose max-w-none text-gray-700">
                {{ profile.bio|linebreaksbr }}
            </div>
        </div>
    </div>
    {% endif %}

    <!-- スキル -->
    {% if profile.skills.all %}
    <div class="mt-6 bg-white shadow rounded-lg">
        <div class="px-4 py-5 sm:p-6">
            <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4">スキル</h3>
            <div class="flex flex-wrap gap-2">
                {% for skill in profile.skills.all %}
                <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-gray-100 text-gray-800">
                    {{ skill.name }}
                </span>
                {% endfor %}
            </div>
        </div>
    </div>
    {% endif %}
    
    <!-- 入社前の経歴 -->
    <div class="mt-6 bg-white shadow rounded-lg">
        <div class="px-4 py-5 sm:p-6">
            <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4">
                <svg class="inline-block mr-2 h-5 w-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 13.255A23.931 23.931 0 0112 15c-3.183 0-6.22-.62-9-1.745M16 6V4a2 2 0 00-2-2h-4a2 2 0 00-2-2v2m8 0V6a2 2 0 00-2 2H8a2 2 0 00-2-2V6m8 0h2.5A1.5 1.5 0 0119 7.5V20a2 2 0 01-2 2H7a2 2 0 01-2-2V7.5A1.5 1.5 0 016.5 6H9"></path>
                </svg>
                入社前の経歴
            </h3>
            
            {% if profile.pre_employment_histories.all %}
                <div class="space-y-4">
                    {% for history in profile.pre_employment_histories.all %}
                        <div class="bg-gray-50 border border-gray-200 rounded-lg p-4 hover:shadow-sm transition-shadow">
                            <div class="flex items-start justify-between">
                                <div class="flex-1">
                                    <h4 class="text-lg font-semibold text-gray-900">{{ history.company_name }}</h4>
                                    <p class="text-sm text-gray-600 mt-1">
                                        {{ history.start_date|date:"Y年m月" }}〜
                                        {% if history.end_date %}
                                            {{ history.end_date|date:"Y年m月" }}
                                        {% else %}
                                            現在
                                        {% endif %}
                                    </p>
                                </div>
                                <div class="ml-4 text-right">
                                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                                        {{ history.job_role|default:"職種不明" }}
                                    </span>
                                </div>
                            </div>
                            
                            <div class="mt-3 grid grid-cols-1 sm:grid-cols-2 gap-3">
                                <div>
                                    <dt class="text-sm font-medium text-gray-500">役職</dt>
                                    <dd class="text-sm text-gray-900">{{ history.job_title|default:"未記入" }}</dd>
                                </div>
                            </div>
                            
                            {% if history.job_description %}
                            <div class="mt-3">
                                <dt class="text-sm font-medium text-gray-500">概要</dt>
                                <dd class="mt-1 text-sm text-gray-700">{{ history.job_description|linebreaksbr }}</dd>
                            </div>
                            {% endif %}
                        </div>
                    {% endfor %}
                </div>
            {% else %}
                <div class="text-center py-8">
                    <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                    </svg>
                    <p class="mt-2 text-sm text-gray-500">入社前の経歴が登録されていません。</p>
                </div>
            {% endif %}
        </div>
    </div>

</div>

{% if request.user.is_hr %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const departmentSelect = document.getElementById('department-select');
    const dteSelect = document.getElementById('dte-select');
    const updateBtn = document.getElementById('update-org-info-btn');
    const updateStatus = document.getElementById('update-status');

    function fetchDTEs(departmentId, selectedDteId) {
        if (!departmentId) {
            dteSelect.innerHTML = '<option value="">DTEを選択</option>';
            return;
        }
        fetch(`/departments/api/departments/${departmentId}/dtes/`)
            .then(response => response.json())
            .then(data => {
                dteSelect.innerHTML = '<option value="">DTEを選択</option>';
                data.forEach(dte => {
                    const option = document.createElement('option');
                    option.value = dte.id;
                    option.textContent = dte.name;
                    if (selectedDteId && dte.id == selectedDteId) {
                        option.selected = true;
                    }
                    dteSelect.appendChild(option);
                });
            })
            .catch(error => {
                console.error('Error fetching DTEs:', error);
            });
    }

    departmentSelect.addEventListener('change', function() {
        fetchDTEs(this.value, null);
    });

    updateBtn.addEventListener('click', function() {
        updateBtn.disabled = true;
        updateBtn.innerHTML = '<svg class="animate-spin mr-2 h-4 w-4" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="m4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>更新中...';
        
        const departmentId = departmentSelect.value;
        const dteId = dteSelect.value;
        const employeeId = "{{ profile.user.pk }}";

        fetch(`/profiles/update-org-info/${employeeId}/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({ department_id: departmentId, dte_id: dteId })
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                updateStatus.innerHTML = '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800"><svg class="mr-1 h-3 w-3" fill="currentColor" viewBox="0 0 8 8"><circle cx="4" cy="4" r="3"/></svg>' + data.message + '</span>';
                document.getElementById('user-org-info-container').innerHTML = data.html;
                setTimeout(() => {
                    updateStatus.innerHTML = '';
                }, 3000);
            } else {
                updateStatus.innerHTML = '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800"><svg class="mr-1 h-3 w-3" fill="currentColor" viewBox="0 0 8 8"><circle cx="4" cy="4" r="3"/></svg>' + data.message + '</span>';
            }
        })
        .catch(error => {
            updateStatus.innerHTML = '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">エラーが発生しました</span>';
        })
        .finally(() => {
            updateBtn.disabled = false;
            updateBtn.innerHTML = '<svg class="mr-2 h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/></svg>更新';
        });
    });

    // Initial fetch for DTEs on page load
    const initialDepartmentId = departmentSelect.value;
    const initialDteId = "{{ profile.user.dte.id|default:'' }}";
    if(initialDepartmentId){
        fetchDTEs(initialDepartmentId, initialDteId);
    }
});
</script>
{% endif %}
{% endblock %}